#!/usr/bin/env bash
set -e

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
cd "$SCRIPT_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

cleanup() {
  echo ""
  echo -e "${YELLOW}Shutting down services...${NC}"
  kill $(jobs -p) 2>/dev/null
  # Kill processes on known ports
  lsof -ti:3000 | xargs kill 2>/dev/null || true
  lsof -ti:3036 | xargs kill 2>/dev/null || true
  lsof -ti:4002 | xargs kill 2>/dev/null || true
  echo -e "${GREEN}All services stopped.${NC}"
  exit 0
}

trap cleanup SIGINT SIGTERM

# Kill any existing processes on our ports
echo -e "${YELLOW}Cleaning up existing processes...${NC}"
lsof -ti:3000 | xargs kill 2>/dev/null || true
lsof -ti:3036 | xargs kill 2>/dev/null || true
lsof -ti:4002 | xargs kill 2>/dev/null || true
sleep 1

# Start wbuilder
echo -e "${GREEN}Starting Website Builder API...${NC}"
(cd apps/wbuilder/api-server && npm install --silent && npm run dev) &

# Start Rails app (with Vite + jobs via foreman)
echo -e "${GREEN}Starting Rails app...${NC}"
(cd apps/web && bin/dev) &

sleep 3

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  All services started!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo -e "  Rails app:     ${YELLOW}http://localhost:3000${NC}"
echo -e "  Vite dev:      ${YELLOW}http://localhost:3036${NC}"
echo -e "  Website Builder: ${YELLOW}http://localhost:4002${NC}"
echo ""
echo -e "  Press ${RED}Ctrl+C${NC} to stop all services"
echo ""

wait
