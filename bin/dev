#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
cd "$SCRIPT_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

PORTS=(3000 3001 3036 4002)

cleanup() {
  echo ""
  echo -e "${YELLOW}Shutting down services...${NC}"
  # Kill all child processes of this shell (catches foreman children too)
  pkill -P $$ 2>/dev/null || true
  sleep 1
  # Force-kill any stragglers on our ports
  for port in "${PORTS[@]}"; do
    lsof -ti:$port | xargs kill -9 2>/dev/null || true
  done
  echo -e "${GREEN}All services stopped.${NC}"
  exit 0
}

trap cleanup SIGINT SIGTERM

# Kill any existing processes on our ports
echo -e "${YELLOW}Cleaning up existing processes...${NC}"
for port in "${PORTS[@]}"; do
  pid=$(lsof -ti:$port 2>/dev/null)
  if [ -n "$pid" ]; then
    echo -e "${YELLOW}Port $port in use (PID $pid), killing...${NC}"
    kill $pid 2>/dev/null || true
  fi
done
sleep 1

# Install dependencies
echo -e "${YELLOW}Installing dependencies...${NC}"
npm install --silent
(cd apps/web && bundle install --quiet && npm install --silent)

# Start wbuilder
echo -e "${GREEN}Starting Website Builder API...${NC}"
(cd apps/wbuilder/api-server && npm install --silent && npm run dev) &
WBUILDER_PID=$!

# Start sgen
echo -e "${GREEN}Starting Sgen API...${NC}"
(cd apps/sgen && npm install --silent && npm run dev) &
SGEN_PID=$!

# Start Rails app (with Vite + jobs via foreman)
echo -e "${GREEN}Starting Rails app...${NC}"
(cd apps/web && bin/dev) &
RAILS_PID=$!

sleep 3

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  All services started!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo -e "  Rails app:       ${YELLOW}http://localhost:3000${NC}"
echo -e "  Vite dev:        ${YELLOW}http://localhost:3036${NC}"
echo -e "  Sgen API:        ${YELLOW}http://localhost:3001${NC}"
echo -e "  Website Builder: ${YELLOW}http://localhost:4002${NC}"
echo ""
echo -e "  ${YELLOW}Dev login:${NC} dev@example.com / password123"
echo -e "  (Run 'cd apps/web && bin/rails db:seed' if not seeded yet)"
echo ""
echo -e "  Press ${RED}Ctrl+C${NC} to stop all services"
echo ""

wait $WBUILDER_PID $SGEN_PID $RAILS_PID
