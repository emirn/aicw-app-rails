---
import type { SiteConfig } from '../lib/config';
import { getDefaultAuthor, generateLetterFavicon } from '../lib/config';

export interface Props {
  title: string;
  description?: string;
  canonical?: string;
  image?: string;
  imageAlt?: string;
  type?: 'website' | 'article';
  publishedTime?: Date;
  modifiedTime?: Date;
  author?: string;
  keywords?: string;
  ogTitle?: string;
  ogDescription?: string;
  twitterTitle?: string;
  twitterDescription?: string;
  config: SiteConfig;
}

const {
  title,
  description,
  canonical,
  image,
  imageAlt,
  type = 'website',
  publishedTime,
  modifiedTime,
  author,
  keywords,
  ogTitle,
  ogDescription,
  twitterTitle,
  twitterDescription,
  config,
} = Astro.props;

// Use canonicalDomain if set (for sites hosted on staging subdomain but indexed under custom domain)
// Otherwise fall back to site.url
const baseUrl = (config.seo.canonicalDomain || config.branding.site.url).replace(/\/$/, '');
const siteUrl = config.branding.site.url.replace(/\/$/, '');

// Build canonical URL using the canonical domain base
const fullCanonical = canonical
  ? (canonical.startsWith('http') ? canonical : new URL(canonical, baseUrl).href)
  : new URL(Astro.url.pathname, baseUrl).href;

const ogImage = image
  ? (image.startsWith('http') ? image : new URL(image, baseUrl).href)
  : config.seo.defaultOgImage
    ? new URL(config.seo.defaultOgImage, baseUrl).href
    : null;
---

<!-- Primary Meta Tags -->
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>{title}</title>
<meta name="description" content={description || config.branding.site.description} />
{keywords && <meta name="keywords" content={keywords} />}
<meta name="author" content={author || getDefaultAuthor(config)} />
<link rel="canonical" href={fullCanonical} />
{config.seo.robotsNoIndex && <meta name="robots" content="noindex, nofollow" />}

<!-- Favicon -->
{config.branding.site.favicon_url ? (
  <link rel="icon" href={config.branding.site.favicon_url} />
) : (
  <link rel="icon" type="image/svg+xml" href={generateLetterFavicon(
    config.branding.site.name,
    config.branding.colors.primary,
    config.branding.logo.mark_text,
    config.branding.logo.style
  )} />
)}

<!-- Open Graph / Facebook -->
<meta property="og:type" content={type} />
<meta property="og:url" content={fullCanonical} />
<meta property="og:title" content={ogTitle || title} />
<meta property="og:description" content={ogDescription || description || config.branding.site.description} />
{ogImage && (
  <>
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:alt" content={imageAlt || title} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
  </>
)}
<meta property="og:site_name" content={config.branding.site.name} />
<meta property="og:locale" content={config.branding.site.language?.replace('-', '_') || 'en_US'} />

{type === 'article' && publishedTime && (
  <>
    <meta property="article:published_time" content={publishedTime.toISOString()} />
    {modifiedTime && <meta property="article:modified_time" content={modifiedTime.toISOString()} />}
    {author && <meta property="article:author" content={author} />}
    {keywords && <meta property="article:tag" content={keywords} />}
  </>
)}

<!-- Twitter -->
<meta name="twitter:card" content={ogImage ? 'summary_large_image' : 'summary'} />
<meta name="twitter:url" content={fullCanonical} />
<meta name="twitter:title" content={twitterTitle || ogTitle || title} />
<meta name="twitter:description" content={twitterDescription || ogDescription || description || config.branding.site.description} />
{ogImage && (
  <>
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:image:alt" content={imageAlt || title} />
  </>
)}
{config.seo.twitterHandle && (
  <meta name="twitter:site" content={config.seo.twitterHandle.startsWith('@') ? config.seo.twitterHandle : `@${config.seo.twitterHandle}`} />
)}

<!-- RSS Feed -->
<link rel="alternate" type="application/rss+xml" title={`${config.branding.site.name} RSS Feed`} href="/rss.xml" />

<!-- Sitemap -->
<link rel="sitemap" href="/sitemap-index.xml" />
